<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>诊断性能问题的工作流程(2) - TomatoPunk</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="murphy"><meta name=description content="原文为Maoni发布在Microfost Blog中的, 诊断性能问题的工作流程系列. 目前共更新三章. 在本章中, Maoni继续介绍了如何进行诊断"><meta name=generator content="Hugo 0.85.0"><link rel=canonical href=https://murph.site/post/2020-05-07-diagnosingmemoryperformance-part2/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css integrity="sha256-+ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media=screen crossorigin=anonymous><meta property="og:title" content="诊断性能问题的工作流程(2)"><meta property="og:description" content="原文为Maoni发布在Microfost Blog中的, 诊断性能问题的工作流程系列. 目前共更新三章. 在本章中, Maoni继续介绍了如何进行诊断"><meta property="og:type" content="article"><meta property="og:url" content="https://murph.site/post/2020-05-07-diagnosingmemoryperformance-part2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-05-07T14:27:26+00:00"><meta property="article:modified_time" content="2020-05-07T14:27:26+00:00"><meta itemprop=name content="诊断性能问题的工作流程(2)"><meta itemprop=description content="原文为Maoni发布在Microfost Blog中的, 诊断性能问题的工作流程系列. 目前共更新三章. 在本章中, Maoni继续介绍了如何进行诊断"><meta itemprop=datePublished content="2020-05-07T14:27:26+00:00"><meta itemprop=dateModified content="2020-05-07T14:27:26+00:00"><meta itemprop=wordCount content="5611"><meta itemprop=keywords content="C#,性能诊断,Maoni,PerfView,"><meta name=twitter:card content="summary"><meta name=twitter:title content="诊断性能问题的工作流程(2)"><meta name=twitter:description content="原文为Maoni发布在Microfost Blog中的, 诊断性能问题的工作流程系列. 目前共更新三章. 在本章中, Maoni继续介绍了如何进行诊断"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-9F0K81DG4J','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>TomatoPunk</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/about>About</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/about/>About Me</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>TomatoPunk</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://murph.site/>Home</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/about>About</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/about/>About Me</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>诊断性能问题的工作流程(2)</h1><div class=post-meta><time datetime=2020-05-07 class=post-time>2020-05-07</time><div class=post-category><a href=https://murph.site/categories/index/>Index</a></div><span class=more-meta>5611 words</span>
<span class=more-meta>12 min read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Table of Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#原文信息>原文信息</a></li><li><a href=#正文>正文</a><ul><li><a href=#请明智的花费精力>请明智的花费精力</a></li><li><a href=#继续分析>继续分析</a></li></ul></li></ul></nav></div></div><div class=post-content><p>原文为Maoni发布在Microfost Blog中的, 诊断性能问题的工作流程系列.
目前共更新三章. 在本章中, Maoni继续介绍了如何进行诊断性能问题, 以及一个略微棘手的问题.</p><h2 id=原文信息>原文信息</h2><p><a href=https://twitter.com/maoni0>@Maoni Stephens-Twitter</a>
<a href=https://github.com/Maoni0>@Maoni Stephens-Github</a></p><p><img src=/posts/images/1587561145552-0d8a560c-3b7d-443a-badc-a98ddbb6e7bf.png alt=authorize></p><p>如果这篇文章可以帮到您，那么这将是我最大的荣幸，希望您点进原文，在文章下方留下善意的回复，您的支持将是这些可敬的社区磐石保持创作激情中最大的一部分:)</p><p><a href=https://devblogs.microsoft.com/dotnet/work-flow-of-diagnosing-memory-performance-issues-part-2>原文</a></p><p><strong>中文版本将不会以任何形式收费，版权属与原作者</strong></p><hr><h2 id=正文>正文</h2><p>在这一章中, 我将讨论一下您应该将精力花费在哪里, 然后继续我的分析. 原本我打算深入研究GCStats视图, 但我刚刚调试了一个长时间挂起的问题. 我想分享给大家, 当您在分析问题时, 其中的一些通用的思路. 当然, 您也可以直接<a href=https://devblogs.microsoft.com/dotnet/work-flow-of-diagnosing-memory-performance-issues-part-2/#continuing-the-analysis>跳到分析部分</a>.</p><h3 id=请明智的花费精力>请明智的花费精力</h3><p>PerfView不仅仅是用于收集痕迹的, 更重要的是, 它是用于分析痕迹的. 我遇到过很多人, 他们仅仅使用Perfview进行收集痕迹. 我真的强烈鼓励您将其作为一个分析工具来使用.</p><p>PerfView中内置了大量的帮助, 显然, 我写这个系列的博客主要原因也是为了帮助您, 只是更侧重内存方面. 我这样做的最终目的-是帮助您
获得一些搞清楚性能问题的思路跟方法, 而不是详细的列出您可能碰到的所有问题, 这完全不现实.</p><p>我的理念是您应该明智的花费自己的时间, 我都非常忙, 有做不完的任务. 我也明白, 我中的许多人的性格都很独立, 喜欢自己想办法.</p><p>所以, 在请别人帮忙之前, 您会自己完成多少工作呢?这是我遵循的几个规则 -</p><ul><li><p>慷慨的花时间去学习以后会经常用到的知识与技能, 如果我正在研究一个以后不大可能再研究的领域中的问题, 我倾向于尽早的寻求帮助, 因为我知道在这里获得的知识可能只会用到一次. 但如果我知道我需要再次解决这个领域的问题, 我会花费尽可能多的时间来了解它.</p></li><li><p>如果我有一个紧急的问题, 而我认识的人多半已经知道答案, 我会尽早的向他们寻求帮助. 而如果是我认为这是我需要知道的事情, 我会先把问题处理好, 然后花费时间去了解更多的细节(其他团队可能正在等待解决方案). 当我真的向对方请求帮助时, 我会提供问题的详细描述与调试的信息给对方, 以节省对方询问的时间.</p></li></ul><h3 id=继续分析>继续分析</h3><p>在<a href=https://devblogs.microsoft.com/dotnet/work-flow-of-diagnosing-memory-performance-issues-part-0/>Part0</a>我提到了我会从两个跟踪来开始调查. 第二个跟踪是获取CPU采样和一些其他的通用事件, 比如磁盘/网络IO :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>PerfView /nogui /accepteula /KernelEvents<span class=o>=</span>default+Memory+VirtualAlloc /ClrEvents:GC+Stack /MaxCollectSec:600 /BufferSize:3000 /CircularMB:3000 collect
</code></pre></td></tr></table></div></div><p>第一个跟踪, 也就是GCCollectOnly跟踪, 是为了准确的了解GC的性能&ndash;您想在最小的干扰下进行收集, 而命令行的参数GCCollectOnly正是做这个的.</p><p>第二个跟踪可以让您了解机器上的运行情况. GC生活在一个进程中的线程中, 其他进程可能会影响GC的运行. 请注意, 目前在dotnet-trace中还没有等效的功能 - 您需要在Linux上使用[perfcollect脚本](<a href=https://github.com/dotnet/coreclr/blob/master/Documentation/project-docs/linux-performance-tracing>https://github.com/dotnet/coreclr/blob/master/Documentation/project-docs/linux-performance-tracing</a>. md#preparing-your-machine)收集跟踪, 例如perf+Lttng, 不幸的是它不能提供完全等同的功能(Lttng没有栈)但是在其他方面, 它确实能提供机器范围的视图, 而不是像dotnet-trace只提供一个进程的事件.</p><p>请注意, 我也指定了 <strong><code>/BufferSize:3000 /CircularMB:3000</code></strong> 参数, 我现在收集的事件比较多, 默认值可能不够用, 对于GCCollectOnly, 我知道它收集的事件不多, 所以默认值就足够了. 一般来说, 我发现3000MB对于这个跟踪的两个参数都是足够的. 如果这些大小有问题, PerfView会给出非常有参考价值的信息, 所以请注意它弹出的对话框! 这是由HandleLostEvents方法触发的:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>private</span> <span class=k>void</span> <span class=n>HandleLostEvents</span><span class=p>(</span><span class=n>Window</span> <span class=n>parentWindow</span><span class=p>,</span><span class=kt>bool</span> <span class=n>truncated</span><span class=p>,</span><span class=kt>int</span> <span class=n>numberOfLostEvents</span><span class=p>,</span><span class=kt>int</span> <span class=n>eventCountAtTrucation</span><span class=p>,</span><span class=n>StatusBar</span> <span class=n>worker</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>string</span> <span class=n>warning</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(!</span><span class=n>truncated</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=c1>// TODO see if we can get the buffer size out of the ETL file to give a good number in the message.  
</span><span class=c1></span>        <span class=n>warning</span> <span class=p>=</span> <span class=s>&#34;WARNING: There were &#34;</span> <span class=p>+</span> <span class=n>numberOfLostEvents</span> <span class=p>+</span> <span class=s>&#34; lost events in the trace. \r\n&#34;</span> <span class=p>+</span>
            <span class=s>&#34;Some analysis might be invalid. \r\n&#34;</span> <span class=p>+</span>
            <span class=s>&#34;Use /InMemoryCircularBuffer or /BufferSize:1024 to avoid this in future traces. &#34;</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>else</span>
    <span class=p>{</span>
        <span class=n>warning</span> <span class=p>=</span> <span class=s>&#34;WARNING: The ETLX file was truncated at &#34;</span> <span class=p>+</span> <span class=n>eventCountAtTrucation</span> <span class=p>+</span> <span class=s>&#34; events. \r\n&#34;</span> <span class=p>+</span>
            <span class=s>&#34;This is to keep the ETLX file size under 4GB,  however all rundown events are processed. \r\n&#34;</span> <span class=p>+</span>
            <span class=s>&#34;Use /SkipMSec:XXX after clearing the cache (File-&gt;Clear Temp Files) to see the later parts of the file. \r\n&#34;</span> <span class=p>+</span>
            <span class=s>&#34;See log for more details. &#34;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><strong><code>If</code></strong> 的情况是告诉您有事件丢失了, 您同时记录了太多的事件, 而缓冲区不够大. 所以它告诉您, 应该通过 <strong><code>/BuffSize</code></strong> 指定一个更大的值. 我一般觉得 <strong><code>/InMemoryCircularBuffer</code></strong> 参数不可靠, 所以我一般不用它.</p><p><strong><code>Else</code></strong> 的情况是告诉您, 您使用的 <strong><code>/CircularMB</code></strong> 参数太大了, 导致PerfView生成的. etlx文件太大, 不能一次解析完, 所以当您使用PerfView查看跟踪时, 它将只显示可以容纳在4GB. etlx中第一部分的信息. 这并不意味着您需要减少这个参数的大小, 这只是意味着您需要采取额外的步骤才能看到所有信息. 要看到后面的部分, 您需要跳过第一部分, 这正是对话框中告诉您需要做的. 通常您会看到这个对话框与第二个跟踪.</p><p>我的做法是, 查看GCStats找出哪个时间段是我感兴趣的, 然后跳过之前的部分. 请注意, 如果您看我在<a href=https://devblogs.microsoft.com/dotnet/gc-perf-infrastructure-part-1/>这篇博客</a>提到的GC性能基础结构的跟踪, 您就不会有这个问题, 因为基础结构会查看. etl文件, 不会经过. etlx的步骤. 这就解释了为什么当您使用GC Perf infra时, 您可以看到比您在PerfView中更多的GC</p><p>指定 <strong><code>/ClrEvents:GC+Stack</code></strong> 参数是很重要的, 运行时的默认会收集大量的关键词:</p><ul><li>Default = GC</li><li>Type</li><li>GCHeapSurvivalAndMovement</li><li>Binder</li><li>Loader</li><li>JIt</li><li>NGen</li><li>SupressNGen</li><li>StopEnumeration</li><li>Security</li><li>AppDomainResourceManagement</li><li>Exception</li><li>Threading</li><li>Contention</li><li>Stack</li><li>JittedMethodILToNativeMap</li><li>ThreadTransfer</li><li>GCHeapAndTypeNames</li><li>Codesymbols</li><li>Compilation</li></ul><p>其中一些会人为的增大很多GC的暂停时间. 比如 <strong><code>GCHeapSurvivalAndMovement</code></strong>, 它实际上向BGC添加了另一个STW暂停, 可能会使BGC的实际STW暂停时间增加十倍以上.</p><p>当我知道自己要专注于GC的性能时, 我会选择不收集rundown事件, 即在命令行中添加 <strong><code>/NoV2Rundown /NoNGENRundown /NoRundown</code></strong> 这意味着我不会得到一些托管的调用帧(ie, moduleA!? instead of something like <strong><code>moduleX!methodFoo(argType)</code></strong> ). 但如果您作为一个使用GC的客户, rundown事件是非常有用的, 您可以得到来自于您代码的托管调用帧, 来验证是否可以通过修改代码来帮助改善性能.</p><p>性能问题的类别之一是偶尔的长时间GC(您可以很容易的在GCCollectOnly的跟踪中发现他们), 您可以使用这个命令行, 让PerfView在观察到长GC时立刻停止跟踪:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>PerfView.exe /nogui /accepteula /StopOnGCOverMSec:100 /Process:MyProcess /DelayAfterTriggerSec:0 /CollectMultiple:3 /KernelEvents<span class=o>=</span>default+Memory+VirtualAlloc /ClrEvents:GC+Stack /BufferSize:3000 /CircularMB:3000 collect
</code></pre></td></tr></table></div></div><p>用您的进程名字替换掉MyProcess(如果您的进程名字是a. exe, 这里的参数不含. exe, 应该是/Process:A)</p><p>用一个恰当的数字替换掉100(如果您想捕获一个500ms的GC, 就用500替换).</p><p>我在<a href=https://devblogs.microsoft.com/dotnet/you-should-never-see-this-callstack-in-production/>这篇博客</a>中解释了很多这样的参数, 所以在这里就不在赘述了.</p><p>这个停止触发器(在本例中是 <strong><code>/StopOnGCOverMSec</code></strong>)是我在PerfView中最喜欢的功能之一. dotnet-trace暂时还没有这个功能(没有不提供的理由, 这是需要处理的工作之一). 我通常会从这里开始, 尤其是当长GC已经相当可观时. 他的开销确实比/GCCollectOnly的大得多, 但不会太大(通常是个位数的百分比). 所以我预测产品仍然可以正常的运行, 并且一直重现同样的问题. 我见过人们追逐由<code>Heisenberg effect(海森堡效应)</code>引发的不同性能问题.</p><p>还有其他的停止触发器. 要获得有关于它们的帮助, 点击Help/Command Line Helper, 然后在帮助页面上搜索StopOn. 你会看到一堆与各种触发条件有关的停止跟踪开关. 与GC相关的有:</p><ul><li>[-StopOnPerfCounter:STRING,…]</li><li>[-StopOnEtwEvent:STRING,…]</li><li>[-StopOnGCOverMsec:0]</li><li>[-StopOnGCSuspendOverMSec:0]</li><li>[-StopOnBGCFinalPauseOverMsec:0]</li></ul><p>前两个是通用的, 所以可以使用在任何的性能计数器/ETW事件上. 我自己从没有手动的使用过-StopOnEtwEvent触发器. 我觉得这个参数很有潜力, 只是我还没有时间去实验它.</p><p>最后三个不需要我解释. <strong><code>StopOnGCOverMSec</code></strong> 是最常用的一个. 请注意, <strong><code>StopOnGCOverMSec</code></strong> 指的是GC/Start与GC/Stop的间隔时间, 如果您指定了/StopOnGCMSec:500, 意味着一旦检测到GC/Start与GC/Stop的间隔超过了500ms, 跟踪就会停止. 如果您正在观察长时间的挂起, 您需要使用 <strong><code>StopOnGCSuspendOverMSec</code></strong> 触发器, 它实际上在内部与StopOnEtwEvent一起实现, 比较 <strong><code>SuspendEEStart</code></strong> 和 <strong><code>SuspendEEStop</code></strong> 时间的间隔触发 -</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>etwStopEvents. Add(&#34;E13C0D23-CCBC-4E12-931B-D9CC2EEE27E4/GC/SuspendEEStart;StopEvent=GC/SuspendEEStop;StartStopID=ThreadID;Keywords=0x1;TriggerMSec=&#34; + StopOnGCSuspendOverMSec);
</code></pre></td></tr></table></div></div><h4 id=长时间挂起>长时间挂起</h4><p>现在来说说我刚调试的客户问题-从来自GCCollectOnly的跟踪中, 我看到一些GC花费了很长的时间在挂起上(3/4秒!). 我还让他们收集了第二个跟踪, 并查看发生长时间挂起期间的CPU采样. 请注意, 出现这种情况时, 只有挂起的时间很长, GC部分是正常的. 还有一种特殊情况是, 挂起与GC的时间都是随机长的, 或其中一个很长. 通常这种情况是有什么东西阻碍了GC线程的运行. 最常见的原因是机器上有一个优先级很高的线程(通常是意外的)在运行时会出现这种情况.</p><p>在这种情况下, 我已经验证了这个问题总是在挂起时才会表现出来. 而从第二个跟踪中, 我可以看到一些IO正在进行, 我知道这可能就是阻止挂起的原因. 然而, 这只是基于我所掌握的知识, 如果我不知道, 我可以做些什么来验证这个理论?另外, 我想展示给我的客户, 到底是如何阻止挂起的. 这个时候就需要一个更加重量级的跟踪, 即 <strong><code>ThreadTime</code></strong> 跟踪. 如果您有一个线程没有完成它的工作, 要么这个工作就是需要很长时间, 要么就是有什么东西导致它长时间的阻塞. 如果它被阻塞了, 在某些时候它会被唤醒, 我想知道是谁唤醒了它. 收集Context Switch(上下文切换)与ReadyThread(准备线程)事件正是做这个的&ndash;看看一个线程为什么会被切换, 以及谁来启用并再次执行它. 在PerfView中叫做 <strong><code>ThreadTime</code></strong> 跟踪. 它仅收集默认的kernel事件加上这两个事件. 所以您可以把 <strong><code>/KernelEvents=default+Memory+VirtualAlloc</code></strong> 替换成 <strong><code>/KernelEvents=ThreadTime+Memory+VirtualAlloc</code></strong> . 这些Context Switch和Ready Thread事件会非常多, 所以有时候原来的问题长时间都不能复现, 在这种情况下, 问题会复现的.</p><p>请查看PerfView的帮助来获得更多使用 <strong>ThreadTime</strong>跟踪的说明.</p><p>当您有Ready Thread事件时, PerfView中的"Advanced Group(高级组)&ldquo;下方会额外多出一个视图, 叫做"ThreadTime(with ReadyThread) stacks - 线程时间(含准备线程))栈&rdquo;. 我通常要做的就是打开这个视图, 搜索阻塞的时间段内被阻塞的调用, 并查看它的"READIED_BY"调用栈, 导致哪些线程被唤醒. 所以我做的是384, 026. 930 到 387, 822. 395的这个时间段, 也就是GCStats标识的挂起事件, 复制到这个视图中的Start和End框中, 然后在Find框中搜索suspend, 并点击Callees. 这就是我所看到的-</p><p>![WorkFlow-suspension-readythread-view](/posts/images/WorkFlow-suspension-readythread-view. jpg)</p><p>我希望看到一个READIED_BY的栈, 它唤醒并调用SuspendEE线程, 确实有一个, 但是没有用, 因为它展示的调用栈不够深, 引发问题的我的代码或者客户代码的一些东西. 它仍然在ntoskrnl中(Windows系统内核).</p><p>所以对于这种情况, 我可以请PerfView的owner来看看(当时已经是深夜了;即便他当时真的响应了, 也未必有时间马上来看, 而且这个看起来也不是什么可以马上解决的小事. 我真的很想把这个问题搞清楚😀), 或者我可以自己想一些其他的办法来取得更多的进展. 当针对一类问题设计的视图不能使用时, 总会有一个视图可以拯救您, 那就是事件视图. 当然, 可能还有其他工具可以解决它们, 比如WPA. 但我上一次认真使用WPA已经是好几年的前的事了, UI和我熟悉的UI已经有很大的不同.</p><p>事件视图是事件的原始版本, 包含在. etl文件中(这并不完全准确, PerfView仍然对一些事件进行了处理;但在多数情况下, 它是非常原始的&ndash;您可以得到事件的名称和每个事件的字段). 而我最感兴趣的ReadyThread事件, 他告诉我哪个线程是由其他的哪个线程唤醒的. 所以我做的第一件事就是过滤到我想看到的事件. 否则会有太多的事件. 我打开"Event"视图, 再次输入开始和结束的时间戳, 就像我在其他视图中做的那样, 然后在Process Filter中输入感兴趣的过程(为了保护隐私, 我仅仅使用X来说明). 为了只过滤挂起和ReadyThread事件, 我在filter框中输入sus|ready. 这将只包含"sus"或"ready"的事件 &ndash;</p><p>![WorkFlow-suspension0](/posts/images/WorkFlow-suspension0. jpg)</p><p>现在, 选中三个事件并输入回车, 现在我只会看到这三个-</p><p>![WorkFlow-suspension1](/posts/images/WorkFlow-suspension1. jpg)</p><p>这里有很多事件, 但我只对那些唤醒我的线程感兴趣, 也就是本例中的GC线程<code>ThreadID 7736</code>(在服务器GC中, SuspendEE总是由Heap0的GC线程调用), 手动检查这些线程是很困难的, 所以我希望只过滤那些有趣的线程. 做到这一点的方法是让事件视图展示一列单独的字段, 这样我就可以进行排序&ndash;在默认情况下, 它只在一列中显示所有字段. 我可以通过点击Cols按钮(&ldquo;Columns To Display"旁边), 选择我想要显示的字段. 我选择了三个字段, 分别是&ndash;</p><p>![WorkFlow-suspension2](/posts/images/WorkFlow-suspension2. jpg)</p><p>现在, 它显示了这三个字段, 然后我按AwakenedThreadID进行排序, 并寻找我的线程7736.</p><p>![WorkFlow-suspension3](/posts/images/WorkFlow-suspension3. jpg)</p><p>果然, 有一个有意思的线程-线程33108. 如果我点击其中一个时间戳, 然后按Alt+S(意味着打开与这个时间戳相关的任意调用栈;您也可以通过上下文的菜单进入), 我看到了这个调用栈&ndash;</p><p>![WorkFlow-suspension4](/posts/images/WorkFlow-suspension4. jpg)</p><p>底部写着"Readied Thread 7736&rdquo;. 而其他的时间戳几乎都有相同的调用栈. 我只显示了运行时里面的部分, 但是对于客户代码里面的部分, 总是同一个dll抛出的异常. 原来这是我挂起代码的一个BUG-它在调用 <strong><code>GetFileVersionInfoSize</code></strong> 系统API之前, 应该先切换到抢占模式. 我猜测这是一个处理异常的代码地址(最上面的异常处理代码叫做 <strong><code>coreclr!DwGetFileVersionInfo</code></strong> ), 它没有被广泛使用, 所以我直到现在才注意到. 对客户来说, 一个变通的方法是避免让他们的dll抛出这些异常, 这样会使它不调用这个运行时的代码地址.</p><p>这就是今天的全部内容了, 如果您有任何反馈, 请一如既往的告诉我.</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>murphy</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-05-07</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=https://murph.site/tags/c#/>C#</a>
<a href=https://murph.site/tags/%E6%80%A7%E8%83%BD%E8%AF%8A%E6%96%AD/>性能诊断</a>
<a href=https://murph.site/tags/maoni/>Maoni</a>
<a href=https://murph.site/tags/perfview/>PerfView</a></div><nav class=post-nav><a class=prev href=/post/2020-11-13-context-in-golang/><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">Go中的Context</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/2020-05-06-diagnosingmemoryperformance-part1/><span class="next-text nav-default">诊断性能问题的工作流程(1)</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:lion.zhang@mail.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg></a><a href=https://github.com/tomatopunk rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=https://murph.site/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span>
<span class=copyright-year>&copy;
2015 -
2022
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>京ICP备2020037990号</span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/load-photoswipe.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>