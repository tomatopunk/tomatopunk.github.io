<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Go中的Context - TomatoPunk</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="murphy"><meta name=description content="原文信息 @ricardo.linck 原文:Context in Golang! Golang应用程序使用Contexts来进行控制与管理非常关健的应用可靠性,例如在concurrent p"><meta name=generator content="Hugo 0.85.0"><link rel=canonical href=https://murph.site/post/2020-11-13-context-in-golang/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css integrity="sha256-+ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media=screen crossorigin=anonymous><meta property="og:title" content="Go中的Context"><meta property="og:description" content="原文信息 @ricardo.linck 原文:Context in Golang! Golang应用程序使用Contexts来进行控制与管理非常关健的应用可靠性,例如在concurrent p"><meta property="og:type" content="article"><meta property="og:url" content="https://murph.site/post/2020-11-13-context-in-golang/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-09-22T14:27:26+00:00"><meta property="article:modified_time" content="2020-09-22T14:27:26+00:00"><meta itemprop=name content="Go中的Context"><meta itemprop=description content="原文信息 @ricardo.linck 原文:Context in Golang! Golang应用程序使用Contexts来进行控制与管理非常关健的应用可靠性,例如在concurrent p"><meta itemprop=datePublished content="2020-09-22T14:27:26+00:00"><meta itemprop=dateModified content="2020-09-22T14:27:26+00:00"><meta itemprop=wordCount content="2479"><meta itemprop=keywords content="Go,Context,上下文,架构设计,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go中的Context"><meta name=twitter:description content="原文信息 @ricardo.linck 原文:Context in Golang! Golang应用程序使用Contexts来进行控制与管理非常关健的应用可靠性,例如在concurrent p"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-224693559-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>TomatoPunk</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://murph.site/about>About</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>TomatoPunk</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://murph.site/>Home</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=https://murph.site/about>About</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>Go中的Context</h1><div class=post-meta><time datetime=2020-09-22 class=post-time>2020-09-22</time><div class=post-category><a href=https://murph.site/categories/go/>Go</a></div><span class=more-meta>2479 words</span>
<span class=more-meta>5 min read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Table of Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#原文信息>原文信息</a></li><li><a href=#使用上下文来包含您的数据>使用上下文来包含您的数据</a></li><li><a href=#超时上下文>超时上下文</a></li><li><a href=#grpc>gRPC</a></li><li><a href=#opentelemetry>OpenTelemetry</a></li><li><a href=#最后的一些想法>最后的一些想法</a></li></ul></li></ul></nav></div></div><div class=post-content><h3 id=原文信息>原文信息</h3><p><a href=https://levelup.gitconnected.com/@ricardo.linck>@ricardo.linck</a>
<a href=https://levelup.gitconnected.com/context-in-golang-98908f042a57>原文:Context in Golang!</a></p><hr><p>Golang应用程序使用Contexts来进行控制与管理非常关健的应用可靠性,例如在<a href=https://levelup.gitconnected.com/goroutines-and-channels-concurrent-programming-in-go-9f9f8495c34d>concurrent programming</a>中的数据共享与取消.这听起来似乎很琐碎,但实际并非如此.在Golang中Contexts的入口点是<code>context</code>包.它非常有用,并且可能是整个语言功能最多的包之一.如果您还没有遇到任何有关上下文之类的东西,您大概很快就会遇到(或者您只是没有注意到它).上下文的用法非常广泛,以至于多数软件包都依赖它,并也假设您也会这样做.它绝对是Golang生态系统中的一个关键组件.</p><p>这里是<code>context</code>软件包的官方文档 <a href=https://golang.org/pkg/context/>https://golang.org/pkg/context/</a>.它真的很棒,并且包含了很多例子.为了尝试拓展它们,来让我们看看我在真实场景是如何使用的.</p><h3 id=使用上下文来包含您的数据>使用上下文来包含您的数据</h3><p>一个常见的使用上下文的用户之一是用于共享数据,或者使用请求作用域的值.当您有多个函数并且想在他们之间共享数据,您可以使用上下文.</p><p>最简单的方法是使用函数 context.WithValue.这个函数会根据父上下文创建一个新的上下文,并对您指定的Key添加一个值.您可以把内部实现看做是上下文的内部是一个map.</p><p>所以您可以添加或者使用Key来找回Values,这是非常强大的,因为它允许您在上下文内部存储任何类型的数据.</p><p>下面是一个用上下文添加和找回数据的例子.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
	<span class=nx>ctx</span> <span class=p>=</span> <span class=nf>addValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
	<span class=nf>readValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>addValue</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;key&#34;</span><span class=p>,</span> <span class=s>&#34;test-value&#34;</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>readValue</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>val</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>)</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><blockquote><p>在上下文中添加和找回值</p></blockquote><p>在Context包设计背后有一种重要的方面,任何操作都会返回一个新的context.Context结构.这意味着您需要记住运行时要用带的返回值,并尽可能的使用新的上下文覆盖旧上下文.</p><p>这是来自于不可更改性(immutability)的关键设计.如果您想了解更多的关于gokang中的不可更改性,您可以阅读我的<a href=https://levelup.gitconnected.com/immutability-in-golang-7a13199060bb>这篇文章</a></p><p>要创建一个带有取消功能的上下文,您只需要使用函数<code>context.WithCancel(ctx)</code>将您的上下文通过参数传递进去.这会返回一个新的上下文与一个取消函数.您只需要调用取消函数,就可以取消上下文.</p><p>下面这个例子来自于<a href=https://medium.com/swlh/hedged-requests-tackling-tail-latency-9cea0a05f577>对冲请求(Hedged Request)</a>实现的带有取消功能的上下文.来让我们快速的回顾一下<a href=https://medium.com/swlh/hedged-requests-tackling-tail-latency-9cea0a05f577>对冲请求(Hedged Request)</a>:我们对一个外部服务发起请求,如果在我们定义的时间没有返回,我们会发出第二个请求.当请求返回了,所有其他的请求都会被取消掉.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;io/ioutil&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
	<span class=nx>neturl</span> <span class=s>&#34;net/url&#34;</span>
	<span class=s>&#34;time&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>queryWithHedgedRequestsWithContext</span><span class=p>(</span><span class=nx>urls</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>urls</span><span class=p>))</span>
	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>
	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>url</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>urls</span> <span class=p>{</span>
		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>u</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>c</span> <span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>c</span> <span class=o>&lt;-</span> <span class=nf>executeQueryWithContext</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>)</span>
		<span class=p>}(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>ch</span><span class=p>)</span>

		<span class=k>select</span> <span class=p>{</span>
		<span class=k>case</span> <span class=nx>r</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span><span class=p>:</span>
			<span class=nf>cancel</span><span class=p>()</span>
			<span class=k>return</span> <span class=nx>r</span>
		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=mi>21</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>):</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=o>&lt;-</span><span class=nx>ch</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>executeQueryWithContext</span><span class=p>(</span><span class=nx>url</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
	<span class=nx>parsedURL</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>neturl</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
	<span class=nx>req</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>{</span><span class=nx>URL</span><span class=p>:</span> <span class=nx>parsedURL</span><span class=p>}</span>
	<span class=nx>req</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>

	<span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>DefaultClient</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
		<span class=k>return</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()</span>
	<span class=p>}</span>

	<span class=k>defer</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
	<span class=nx>body</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Request time: %d ms from url%s\n&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>start</span><span class=p>).</span><span class=nf>Nanoseconds</span><span class=p>()</span><span class=o>/</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>.</span><span class=nf>Nanoseconds</span><span class=p>(),</span> <span class=nx>url</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s from %s&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>,</span> <span class=nx>url</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>每个请求都是在一个独立的go routine中触发的.这个上下文被传递给所有触发的请求.唯一的逻辑就是将上下文传播给Http client.以便当取消函数辈调用时,可以优雅的取消请求和底层连接.对于接受context.Context作为参数的函数来说,这是一个非常常见的模式,它们要么主动地对上下文采取行动(比如检查它们是否已经取消),要么将它们传递给处理它的底层函数(本例中是通过http.Request的Do函数接受上下文)</p><h3 id=超时上下文>超时上下文</h3><p>在处理外部请求时,超时是一种非常常见的模式,类似通过Http或gRPC查询数据库或者从其他服务中获取数据.使用Context包处理这些产经非常简单.您所需要做的就是调用函数<code>context.WithTimeout(ctx,time)</code>,传递您的上下文与实际的超时时间,类似这样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=mi>100</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>您仍然可以接受到取消函数,以防您想手动触发它.它的工作方式与普通的超时上下文相同.</p><blockquote><p>一个好做法是,使用defer调用取消函数,避免内存泄露</p></blockquote><p>这个例子的行为非常直接.如果超时了,上下文会被取消.在HTTP调用的情况下,它的工作原理与上面的例子基本相同</p><h3 id=grpc>gRPC</h3><p>Context是gRPC在golang的实现中的一个基本部分.它即用来共享数据(如何取消<a href=https://github.com/grpc/grpc-go/blob/master/Documentation/grpc-metadata.md>元数据</a>)也用来控制流量,类似于取消流或请求.这是我的两个例子,来自于<a href=https://github.com/RicardoLinck/grpc-go>GitHub存储库</a>.</p><h4 id=metadata>Metadata</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>Sum</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>calculatorpb</span><span class=p>.</span><span class=nx>SumRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>calculatorpb</span><span class=p>.</span><span class=nx>SumResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Sum rpc invoked with req: %v\n&#34;</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
	<span class=nx>md</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>FromIncomingContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Metadata received: %v&#34;</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span>
	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>calculatorpb</span><span class=p>.</span><span class=nx>SumResponse</span><span class=p>{</span>
		<span class=nx>Result</span><span class=p>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NumA</span> <span class=o>+</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NumB</span><span class=p>,</span>
	<span class=p>},</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><blockquote><p>Server implementation receiving metadata</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>sum</span><span class=p>(</span><span class=nx>c</span> <span class=nx>calculatorpb</span><span class=p>.</span><span class=nx>CalculatorServiceClient</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>req</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>calculatorpb</span><span class=p>.</span><span class=nx>SumRequest</span><span class=p>{</span>
		<span class=nx>NumA</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
		<span class=nx>NumB</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>AppendToOutgoingContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=s>&#34;user&#34;</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>)</span>
	<span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Sum</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error calling Sum RPC: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Response: %d\n&#34;</span><span class=p>,</span> <span class=nx>res</span><span class=p>.</span><span class=nx>Result</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><blockquote><p>Client implementation sending metadata</p></blockquote><h4 id=calcellation>Calcellation:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>Greet</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>greetpb</span><span class=p>.</span><span class=nx>GreetRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>greetpb</span><span class=p>.</span><span class=nx>GreetResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Greet rpc invoked!&#34;</span><span class=p>)</span>

	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span> <span class=o>==</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Canceled</span><span class=p>,</span> <span class=s>&#34;Client cancelled the request&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>first</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Greeting</span><span class=p>.</span><span class=nx>FirstName</span>
	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>greetpb</span><span class=p>.</span><span class=nx>GreetResponse</span><span class=p>{</span>
		<span class=nx>Result</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Hello %s&#34;</span><span class=p>,</span> <span class=nx>first</span><span class=p>),</span>
	<span class=p>},</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><blockquote><p>Server implementation handling context cancellation</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go>
<span class=kd>func</span> <span class=nf>greetWithTimeout</span><span class=p>(</span><span class=nx>c</span> <span class=nx>greetpb</span><span class=p>.</span><span class=nx>GreetServiceClient</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>req</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>greetpb</span><span class=p>.</span><span class=nx>GreetRequest</span><span class=p>{</span>
		<span class=nx>Greeting</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>greetpb</span><span class=p>.</span><span class=nx>Greeting</span><span class=p>{</span>
			<span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;Ricardo&#34;</span><span class=p>,</span>
			<span class=nx>LastName</span><span class=p>:</span>  <span class=s>&#34;Linck&#34;</span><span class=p>,</span>
		<span class=p>},</span>
	<span class=p>}</span>
	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=mi>100</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
	<span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Greet</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>grpcErr</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>FromError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>

		<span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nx>grpcErr</span><span class=p>.</span><span class=nf>Code</span><span class=p>()</span> <span class=o>==</span> <span class=nx>codes</span><span class=p>.</span><span class=nx>DeadlineExceeded</span> <span class=p>{</span>
				<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Deadline Exceeded&#34;</span><span class=p>)</span>
			<span class=p>}</span>
		<span class=p>}</span>

		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error calling Greet RPC: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Response: %s\n&#34;</span><span class=p>,</span> <span class=nx>res</span><span class=p>.</span><span class=nx>Result</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=opentelemetry>OpenTelemetry</h3><p><code>OpenTelemetry </code>还严重依赖于上下文来实现所谓的<strong>上下文传播(Context Propagation)</strong>.这是一种将不同系统中请求捆绑起来的做法.实现方式是将Span信息<code>注入(Inject)</code>到上下文中,作为您使用的协议的一部分(例如HTTP或gRPC).在另一个服务上,您需要<code>提取(Extrace)</code>Span信息.我在两篇文章中写过关于OpenTelemetry的文章,您可以在之类找到<a href=https://medium.com/swlh/distributed-tracing-with-opentelemetry-part-1-6719df95a364>part 1</a>,<a href=https://levelup.gitconnected.com/distributed-tracing-with-opentelemetry-part-2-cc5a9a8aa88c>part 2</a>.在这里您可以找到更多的关于OpenTelemetry的信息,以及使用gRPC和HTTP的例子.</p><h3 id=最后的一些想法>最后的一些想法</h3><p>上下文是作为Golang基本特性的一部分.因此理解并知道如何使用它们是非常重要的.<code>Context</code>包提供了一个非常简单和轻量级的API来与这个关键组件进行交互.关于<code>context.Context</code>的另一个重要的事情是,它可以用于多种事情.我们再这篇文章中涉及到了很多场景,在其中一些场景中,一个单一的上下文可以用来控制和携带范围值.这使得上下文成为创建可靠和简单代码的一个非常重要和强大的工具.</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>murphy</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-09-22</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=https://murph.site/tags/go/>Go</a>
<a href=https://murph.site/tags/context/>Context</a>
<a href=https://murph.site/tags/%E4%B8%8A%E4%B8%8B%E6%96%87/>上下文</a>
<a href=https://murph.site/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>架构设计</a></div><nav class=post-nav><a class=prev href=/post/2020-11-07-diagnosingmemoryperformance-part0/><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg></i><span class="prev-text nav-default">诊断性能问题的工作流程(0)</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/2020-05-07-diagnosingmemoryperformance-part2/><span class="next-text nav-default">诊断性能问题的工作流程(2)</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:lion.zhang@mail.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg></a><a href=https://github.com/tomatopunk rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=https://murph.site/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span>
<span class=copyright-year>&copy;
2015 -
2022
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>京ICP备2020037990号</span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/load-photoswipe.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>